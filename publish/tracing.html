
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2014-12-11
 Rendered using Reflow Maven Skin 1.1.0 (http://andriusvelykis.github.io/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Tracing | Apache Phoenix</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />

		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.3.2/flatly/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="./css/bootswatch.css" rel="stylesheet" />
		<link href="./css/reflow-skin.css" rel="stylesheet" />

		<link href="http://yandex.st/highlightjs/7.5/styles/default.min.css" rel="stylesheet" />
		
		<link href="./css/lightbox.css" rel="stylesheet" />
		
		<link href="./css/site.css" rel="stylesheet" />
		<link href="./css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->



	</head>

	<body class="page-tracing project-phoenix-site" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target="#top-nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="index.html"><div class="xtoplogo"></div></a>
					<div class="nav-collapse collapse" id="top-nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="index.html" title="Overview">Overview</a></li>
									<li ><a href="recent.html" title="New Features">New Features</a></li>
									<li ><a href="roadmap.html" title="Roadmap">Roadmap</a></li>
									<li ><a href="performance.html" title="Performance">Performance</a></li>
									<li ><a href="team.html" title="Team">Team</a></li>
									<li ><a href="contributing.html" title="Contributing">Contributing</a></li>
									<li ><a href="resources.html" title="Resources">Resources</a></li>
									<li ><a href="mailing_list.html" title="Mailing Lists">Mailing Lists</a></li>
									<li ><a href="source.html" title="Source Repository">Source Repository</a></li>
									<li ><a href="issues.html" title="Issue Tracking">Issue Tracking</a></li>
									<li ><a href="download.html" title="Download">Download</a></li>
									<li class="divider"/>
									<li ><a href="release.html" title="How to release">How to release</a></li>
									<li ><a href="building_website.html" title="How to update website">How to update website</a></li>
									<li class="divider"/>
									<li ><a href="http://www.apache.org/licenses/" title="License" class="externalLink">License</a></li>
									<li ><a href="http://www.apache.org/foundation/sponsorship.html" title="Sponsorship" class="externalLink">Sponsorship</a></li>
									<li ><a href="http://www.apache.org/foundation/thanks.html" title="Thanks" class="externalLink">Thanks</a></li>
									<li ><a href="http://www.apache.org/security/" title="Security" class="externalLink">Security</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Using <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="faq.html" title="F.A.Q.">F.A.Q.</a></li>
									<li ><a href="Phoenix-in-15-minutes-or-less.html" title="Quick Start">Quick Start</a></li>
									<li ><a href="building.html" title="Building">Building</a></li>
									<li ><a href="tuning.html" title="Tuning">Tuning</a></li>
									<li ><a href="upgrading.html" title="Upgrading">Upgrading</a></li>
									<li class="divider"/>
									<li ><a href="secondary_indexing.html" title="Secondary Indexes">Secondary Indexes</a></li>
									<li ><a href="joins.html" title="Joins">Joins</a></li>
									<li ><a href="subqueries.html" title="Subqueries">Subqueries</a></li>
									<li ><a href="views.html" title="Views">Views</a></li>
									<li ><a href="multi-tenancy.html" title="Multi tenancy">Multi tenancy</a></li>
									<li ><a href="sequences.html" title="Sequences">Sequences</a></li>
									<li ><a href="array_type.html" title="ARRAY type">ARRAY type</a></li>
									<li ><a href="salted.html" title="Salted Tables">Salted Tables</a></li>
									<li ><a href="paged.html" title="Paged Queries">Paged Queries</a></li>
									<li ><a href="dynamic_columns.html" title="Dynamic Columns">Dynamic Columns</a></li>
									<li ><a href="skip_scan.html" title="Skip Scan">Skip Scan</a></li>
									<li ><a href="bulk_dataload.html" title="Bulk Loading">Bulk Loading</a></li>
									<li class="active"><a href="" title="Tracing">Tracing</a></li>
									<li ><a href="update_statistics.html" title="Statistics Collection">Statistics Collection</a></li>
									<li class="divider"/>
									<li ><a href="phoenix_on_emr.html" title="Amazon EMR Support">Amazon EMR Support</a></li>
									<li ><a href="flume.html" title="Apache Flume Plugin">Apache Flume Plugin</a></li>
									<li ><a href="pig_integration.html" title="Apache Pig Integration">Apache Pig Integration</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="language/index.html" title="Grammar">Grammar</a></li>
									<li ><a href="language/functions.html" title="Functions">Functions</a></li>
									<li ><a href="language/datatypes.html" title="Datatypes">Datatypes</a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->

	<header>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="page-header">
 <h1>Tracing</h1>
</div> 
<p>As of Phoenix 4.1.0 we have added the ability to collect per-request traces. This allows you to see each important step in a query or insertion, all they way from the client through into the HBase side, and back again.</p> 
<p>We leverage Cloudera’s <a class="externalLink" href="https://github.com/cloudera/htrace">HTrace</a> library to seamlessly integrate with HBase’s tracing utilities. We then take it a step further by then depositing these metrics into a Hadoop metrics2 sink that writes them into a phoenix table.</p> 
<p><b>Writing traces to a phoenix table is not supported on Hadoop1</b></p> 
<div class="section"> 
 <h2 id="Configuration">Configuration</h2> 
 <p>There are two key configuration files that you will need to update.</p> 
 <ul> 
  <li>hadoop-metrics2-phoenix.properties</li> 
  <li>hadoop-metrics2-hbase.properties</li> 
 </ul> 
 <p>They contain the properties you need to set on the client and server, respectively, as well as information on how the metrics2 system uses the configuation files.</p> 
 <p>Put these filse on their respective classpaths and restart the process to pick-up the new configurations.</p> 
 <div class="section"> 
  <h3 id="hadoop-metrics2-phoenix.properties">hadoop-metrics2-phoenix.properties</h3> 
  <p>This file will configure the <a class="externalLink" href="http://hadoop.apache.org/docs/current/api/index.html?org/apache/hadoop/metrics2/package-summary.html">Hadoop Metrics2</a> system for <i>Phoenix clients</i>. </p> 
  <p>The default properties you should set are:</p> 
  <div class="source"> 
   <pre># Sample from all the sources every 10 seconds
*.period=10

# Write Traces to Phoenix
##########################
# ensure that we receive traces on the server
phoenix.sink.tracing.class=org.apache.phoenix.trace.PhoenixMetricsSink
# Tell the sink where to write the metrics
phoenix.sink.tracing.writer-class=org.apache.phoenix.trace.PhoenixTableMetricsWriter
# Only handle traces with a context of &quot;tracing&quot;
phoenix.sink.tracing.context=tracing
</pre> 
  </div> 
  <p>This enables standard Phoenix metrics sink (which collects the trace information) and writer (writes the traces to the Phoenix SYSTEM.TRACING_STATS table). You can modify this to set your own custom classes as well, if you have them.</p> 
  <p>See the properties file in the source (phoenix-hadop2-compat/bin) for more information on setting your own sinks and writer.</p> 
 </div> 
 <div class="section"> 
  <h3 id="hadoop-metrics2-hbase.properties">hadoop-metrics2-hbase.properties</h3> 
  <p>HBase default deployment already comes with a metrics2 configuration, so the metrics2 configuration from phoenix can either replace the existing file (if you don’t have any special configurations) or the properties can be copied to your exisiting metrics2 configuration file.</p> 
  <div class="source"> 
   <pre># ensure that we receive traces on the server
hbase.sink.tracing.class=org.apache.phoenix.trace.PhoenixMetricsSink
# Tell the sink where to write the metrics
hbase.sink.tracing.writer-class=org.apache.phoenix.trace.PhoenixTableMetricsWriter
# Only handle traces with a context of &quot;tracing&quot;
hbase.sink.tracing.context=tracing
</pre> 
  </div> 
  <p>They are essentially the same properties as in the hadoop-metrics2-phoenix.properties but prefixed by “hbase” rather than “phoenix” so they are loaded with the rest of the HBase metrics.</p> 
 </div> 
 <div class="section"> 
  <h3 id="Disabling_Tracing"><u>Disabling Tracing</u></h3> 
  <p>You can disable tracing client requests merely by creating a new Connection that doesn’t have the tracing property enabled (see below).</p> 
  <p>However, on the server-side once the metrics sink has been enabled you cannot turn of trace collection and writing unless you <b>remove the Phoenix metrics2 confgiuration and bounce the regionserver</b>. This is enforced by the metrics2 framework as its assumed that you will always want to collect information about the server you are running on.</p> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Usage">Usage</h2> 
 <p>There are only a couple small things you need to do to enable tracing a given request with Phoenix.</p> 
 <div class="section"> 
  <h3 id="Client_Property">Client Property</h3> 
  <p>The frequency of tracing is determined by the following client-side Phoenix property:</p> 
  <div class="source"> 
   <pre>phoenix.trace.frequency
</pre> 
  </div> 
  <p>There are three possible tracing frequencies you can use:</p> 
  <ol style="list-style-type: decimal"> 
   <li>never 
    <ul> 
     <li>This is the default</li> 
    </ul></li> 
   <li>always 
    <ul> 
     <li>Every request will be traced</li> 
    </ul></li> 
   <li>probability 
    <ul> 
     <li>take traces with a probabilistic frequency</li> 
     <li>probability threshold is set by <tt>phoenix.trace.probability.threshold</tt> with a default of 0.05 (5%).</li> 
    </ul></li> 
  </ol> 
  <p>As with other configuration properties, this property may be specified at JDBC connection time as a connection property. By turning one of these properties on, you turn on merely collecting the traces. However, the traces need to be deposited somewhere</p> 
  <p>Example:</p> 
  <div class="source"> 
   <pre># Enable tracing on every request
Properties props = new Properties();
props.setProperty(&quot;phoenix.trace.frequency&quot;, &quot;always&quot;);
Connection conn = DriverManager.getConnection(&quot;jdbc:phoenix:localhost&quot;, props);

# Enable tracing on 50% of requests
props.setProperty(&quot;phoenix.trace.frequency&quot;, &quot;probability&quot;);
props.setProperty(&quot;phoenix.trace.probability.threshold&quot;, 0.5)
Connection conn = DriverManager.getConnection(&quot;jdbc:phoenix:localhost&quot;, props);
</pre> 
  </div> 
  <div class="section"> 
   <h4 id="hbase-site.xml">hbase-site.xml</h4> 
   <p>You can also enable tracing via hbase-site.xml. However, only “always” and “never” are currently supported.</p> 
   <div class="source"> 
    <pre>&lt;configuration&gt;
  &lt;property&gt;
	&lt;name&gt;phoenix.trace.frequency&lt;/name&gt;
    &lt;value&gt;always&lt;/value&gt;
  &lt;/property&gt;
&lt;/configuration&gt;
</pre> 
   </div> 
  </div> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Reading_Traces">Reading Traces</h2> 
 <p>Once the traces are deposited into the tracing table, by default <tt>SYSTEM.TRACING_STATS</tt>, but it is configurable in the HBase configuration via:</p> 
 <div class="source"> 
  <pre>  &lt;property&gt;
    &lt;name&gt;phoenix.trace.statsTableName&lt;/name&gt;
    &lt;value&gt;&lt;your custom tracing table name&gt;&lt;/value&gt;
  &lt;/property&gt;
</pre> 
 </div> 
 <p>The tracing table is initialized via the ddl:</p> 
 <div> 
  <pre>
    CREATE TABLE <b>SYSTEM.TRACING_STATS</b> (
      <b>trace_id</b> BIGINT NOT NULL,
      <b>parent_id</b> BIGINT NOT NULL,
      <b>span_id</b> BIGINT NOT NULL,
      <b>description</b> VARCHAR,
      <b>start_time</b> BIGINT,
      <b>end_time</b> BIGINT,
      <b>hostname</b> VARCHAR,
      <b>tags.count</b> SMALLINT,
      <b>annotations.count</b> SMALLINT,
      CONSTRAINT pk PRIMARY KEY (<b>trace_id, parent_id, span_id</b>)
</pre> 
 </div> 
 <p>The tracing table also contains a number of dynamic columns for each trace, identified by a unique trace-id (id of the request), parent-id (id of the parent span) and individual span-id (id of the individual segment), may have multiple tags and annotations about what happened during the trace. Once you have the number of tags and annotations, you can retrieve them the table with a request like:</p> 
 <div class="source"> 
  <pre>SELECT &lt;columns&gt;
  FROM SYSTEM.TRACING_STATS
  WHERE trace_id = ?
  AND parent_id = ?
  ANd span_id = ?
</pre> 
 </div> 
 <p>where columns is either <tt>annotations.aX</tt> or <tt>tags.tX</tt> where <tt>X</tt> is the index of the dynamic column to lookup.</p> 
 <p>For more usage, look at our generic <a class="externalLink" href="https://github.com/apache/phoenix/blob/master/phoenix-core/src/main/java/org/apache/phoenix/trace/TraceReader.java">TraceReader</a> which can programatically read a number of traces from the tracing results table.</p> 
 <p>Custom annotations can also be passed into Phoenix to be added to traces. Phoenix looks for connection properties whose names start with <tt>phoenix.annotation.</tt> and adds these as annotations to client-side traces. e.g. A connection property <tt>phoenix.annotation.myannotation=abc</tt> will result in annotations with key <tt>myannotation</tt> and value <tt>abc</tt> to be added to traces. Use this feature to link traces to other request identifiers in your system, such as user or session ids.</p> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">About</li>
						<li >
							<a href="index.html" title="Overview">Overview</a>
						</li>
						<li >
							<a href="recent.html" title="New Features">New Features</a>
						</li>
						<li >
							<a href="roadmap.html" title="Roadmap">Roadmap</a>
						</li>
						<li >
							<a href="performance.html" title="Performance">Performance</a>
						</li>
						<li >
							<a href="team.html" title="Team">Team</a>
						</li>
						<li >
							<a href="contributing.html" title="Contributing">Contributing</a>
						</li>
						<li >
							<a href="resources.html" title="Resources">Resources</a>
						</li>
						<li >
							<a href="mailing_list.html" title="Mailing Lists">Mailing Lists</a>
						</li>
						<li >
							<a href="source.html" title="Source Repository">Source Repository</a>
						</li>
						<li >
							<a href="issues.html" title="Issue Tracking">Issue Tracking</a>
						</li>
						<li >
							<a href="download.html" title="Download">Download</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="release.html" title="How to release">How to release</a>
						</li>
						<li >
							<a href="building_website.html" title="How to update website">How to update website</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="http://www.apache.org/licenses/" title="License" class="externalLink">License</a>
						</li>
						<li >
							<a href="http://www.apache.org/foundation/sponsorship.html" title="Sponsorship" class="externalLink">Sponsorship</a>
						</li>
						<li >
							<a href="http://www.apache.org/foundation/thanks.html" title="Thanks" class="externalLink">Thanks</a>
						</li>
						<li >
							<a href="http://www.apache.org/security/" title="Security" class="externalLink">Security</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Using</li>
						<li >
							<a href="faq.html" title="F.A.Q.">F.A.Q.</a>
						</li>
						<li >
							<a href="Phoenix-in-15-minutes-or-less.html" title="Quick Start">Quick Start</a>
						</li>
						<li >
							<a href="building.html" title="Building">Building</a>
						</li>
						<li >
							<a href="tuning.html" title="Tuning">Tuning</a>
						</li>
						<li >
							<a href="upgrading.html" title="Upgrading">Upgrading</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="secondary_indexing.html" title="Secondary Indexes">Secondary Indexes</a>
						</li>
						<li >
							<a href="joins.html" title="Joins">Joins</a>
						</li>
						<li >
							<a href="subqueries.html" title="Subqueries">Subqueries</a>
						</li>
						<li >
							<a href="views.html" title="Views">Views</a>
						</li>
						<li >
							<a href="multi-tenancy.html" title="Multi tenancy">Multi tenancy</a>
						</li>
						<li >
							<a href="sequences.html" title="Sequences">Sequences</a>
						</li>
						<li >
							<a href="array_type.html" title="ARRAY type">ARRAY type</a>
						</li>
						<li >
							<a href="salted.html" title="Salted Tables">Salted Tables</a>
						</li>
						<li >
							<a href="paged.html" title="Paged Queries">Paged Queries</a>
						</li>
						<li >
							<a href="dynamic_columns.html" title="Dynamic Columns">Dynamic Columns</a>
						</li>
						<li >
							<a href="skip_scan.html" title="Skip Scan">Skip Scan</a>
						</li>
						<li >
							<a href="bulk_dataload.html" title="Bulk Loading">Bulk Loading</a>
						</li>
						<li class="active">
							<a href="#" title="Tracing">Tracing</a>
						</li>
						<li >
							<a href="update_statistics.html" title="Statistics Collection">Statistics Collection</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="phoenix_on_emr.html" title="Amazon EMR Support">Amazon EMR Support</a>
						</li>
						<li >
							<a href="flume.html" title="Apache Flume Plugin">Apache Flume Plugin</a>
						</li>
						<li >
							<a href="pig_integration.html" title="Apache Pig Integration">Apache Pig Integration</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Reference</li>
						<li >
							<a href="language/index.html" title="Grammar">Grammar</a>
						</li>
						<li >
							<a href="language/functions.html" title="Functions">Functions</a>
						</li>
						<li >
							<a href="language/datatypes.html" title="Datatypes">Datatypes</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<form action="http://search-hadoop.com/?" method="get"><input value="Phoenix" name="fc_project" type="hidden"><input placeholder="Search Phoenix&hellip;" required="required" style="width:170px;" size="18" name="q" id="query" type="search"></form>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2014 <a href="http://www.apache.org">Apache Software Foundation</a>. All Rights Reserved.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<script src="./js/lightbox.js"></script>
	<script src="./js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="./js/jquery.ba-bbq.min.js"></script>
	<script src="http://yandex.st/highlightjs/7.5/highlight.min.js"></script>

	<script src="./js/reflow-skin.js"></script>
	
	</body>
</html>
