
<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia at 2014-12-11
 Rendered using Reflow Maven Skin 1.1.0 (http://andriusvelykis.github.io/reflow-maven-skin)
-->
<html  xml:lang="en" lang="en">

	<head>
		<meta charset="UTF-8" />
		<title>Subqueries | Apache Phoenix</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="" />
		<meta http-equiv="content-language" content="en" />

		<link href="http://netdna.bootstrapcdn.com/bootswatch/2.3.2/flatly/bootstrap.min.css" rel="stylesheet" />
		<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" rel="stylesheet" />
		<link href="./css/bootswatch.css" rel="stylesheet" />
		<link href="./css/reflow-skin.css" rel="stylesheet" />

		<link href="http://yandex.st/highlightjs/7.5/styles/default.min.css" rel="stylesheet" />
		
		<link href="./css/lightbox.css" rel="stylesheet" />
		
		<link href="./css/site.css" rel="stylesheet" />
		<link href="./css/print.css" rel="stylesheet" media="print" />
		
		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->



	</head>

	<body class="page-subqueries project-phoenix-site" data-spy="scroll" data-offset="60" data-target="#toc-scroll-target">

		<div class="navbar navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<a class="btn btn-navbar" data-toggle="collapse" data-target="#top-nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</a>
					<a class="brand" href="index.html"><div class="xtoplogo"></div></a>
					<div class="nav-collapse collapse" id="top-nav-collapse">
						<ul class="nav pull-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">About <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="index.html" title="Overview">Overview</a></li>
									<li ><a href="recent.html" title="New Features">New Features</a></li>
									<li ><a href="roadmap.html" title="Roadmap">Roadmap</a></li>
									<li ><a href="performance.html" title="Performance">Performance</a></li>
									<li ><a href="team.html" title="Team">Team</a></li>
									<li ><a href="contributing.html" title="Contributing">Contributing</a></li>
									<li ><a href="resources.html" title="Resources">Resources</a></li>
									<li ><a href="mailing_list.html" title="Mailing Lists">Mailing Lists</a></li>
									<li ><a href="source.html" title="Source Repository">Source Repository</a></li>
									<li ><a href="issues.html" title="Issue Tracking">Issue Tracking</a></li>
									<li ><a href="download.html" title="Download">Download</a></li>
									<li class="divider"/>
									<li ><a href="release.html" title="How to release">How to release</a></li>
									<li ><a href="building_website.html" title="How to update website">How to update website</a></li>
									<li class="divider"/>
									<li ><a href="http://www.apache.org/licenses/" title="License" class="externalLink">License</a></li>
									<li ><a href="http://www.apache.org/foundation/sponsorship.html" title="Sponsorship" class="externalLink">Sponsorship</a></li>
									<li ><a href="http://www.apache.org/foundation/thanks.html" title="Thanks" class="externalLink">Thanks</a></li>
									<li ><a href="http://www.apache.org/security/" title="Security" class="externalLink">Security</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Using <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="faq.html" title="F.A.Q.">F.A.Q.</a></li>
									<li ><a href="Phoenix-in-15-minutes-or-less.html" title="Quick Start">Quick Start</a></li>
									<li ><a href="building.html" title="Building">Building</a></li>
									<li ><a href="tuning.html" title="Tuning">Tuning</a></li>
									<li ><a href="upgrading.html" title="Upgrading">Upgrading</a></li>
									<li class="divider"/>
									<li ><a href="secondary_indexing.html" title="Secondary Indexes">Secondary Indexes</a></li>
									<li ><a href="joins.html" title="Joins">Joins</a></li>
									<li class="active"><a href="" title="Subqueries">Subqueries</a></li>
									<li ><a href="views.html" title="Views">Views</a></li>
									<li ><a href="multi-tenancy.html" title="Multi tenancy">Multi tenancy</a></li>
									<li ><a href="sequences.html" title="Sequences">Sequences</a></li>
									<li ><a href="array_type.html" title="ARRAY type">ARRAY type</a></li>
									<li ><a href="salted.html" title="Salted Tables">Salted Tables</a></li>
									<li ><a href="paged.html" title="Paged Queries">Paged Queries</a></li>
									<li ><a href="dynamic_columns.html" title="Dynamic Columns">Dynamic Columns</a></li>
									<li ><a href="skip_scan.html" title="Skip Scan">Skip Scan</a></li>
									<li ><a href="bulk_dataload.html" title="Bulk Loading">Bulk Loading</a></li>
									<li ><a href="tracing.html" title="Tracing">Tracing</a></li>
									<li ><a href="update_statistics.html" title="Statistics Collection">Statistics Collection</a></li>
									<li class="divider"/>
									<li ><a href="phoenix_on_emr.html" title="Amazon EMR Support">Amazon EMR Support</a></li>
									<li ><a href="flume.html" title="Apache Flume Plugin">Apache Flume Plugin</a></li>
									<li ><a href="pig_integration.html" title="Apache Pig Integration">Apache Pig Integration</a></li>
								</ul>
							</li>
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li ><a href="language/index.html" title="Grammar">Grammar</a></li>
									<li ><a href="language/functions.html" title="Functions">Functions</a></li>
									<li ><a href="language/datatypes.html" title="Datatypes">Datatypes</a></li>
								</ul>
							</li>
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>
		
	<div class="container">
	
	<!-- Masthead
	================================================== -->

	<header>
	</header>

	<div class="main-body">
	<div class="row">
		<div class="span12">
			<div class="body-content">
<div class="page-header">
 <h1>Subqueries</h1>
</div> 
<p>Phoenix now supports subqueries in the <i>WHERE</i> clause and the <i>FROM</i> clause. Subqueries can be specified in many places, like <i>IN/NOT IN</i>, <i>EXISTS/NOT EXISTS</i>, unmodified comparison operators or <i>ANY/SOME/ALL</i> comparison operators.</p> 
<div class="section"> 
 <h2 id="Subqueries_with_IN_or_NOT_IN">Subqueries with IN or NOT IN</h2> 
 <p>The following query finds the names of the items that have sales record after Sept 2nd 2013. The inner query returns a list of items that satisfy the search criteria and the outer query will make use of this list to find matching entries.</p> 
 <div class="source"> 
  <pre>SELECT ItemName
FROM Items 
WHERE ItemID IN 
    (SELECT ItemID
     FROM Orders
     WHERE Date &gt;= to_date('2013/09/02'));
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Subqueries_with_EXISTS_or_NOT_EXISTS">Subqueries with EXISTS or NOT EXISTS</h2> 
 <p>EXISTS simply tests the existence of the returned rows by the inner query. If the inner query returns one or more rows, EXISTS returns a value of <i>TRUE</i>; otherwise a value of <i>FALSE</i>. Many EXISTS queries are used to achieve the same goal as with IN queries or with ANY/SOME/ALL comparison queries. The below query returns the same results as the query in the previous example does:</p> 
 <div class="source"> 
  <pre>SELECT ItemName
FROM Items i
WHERE EXISTS 
    (SELECT *
     FROM Orders
     WHERE Date &gt;= to_date('2013/09/02')
     AND ItemID = i.ItemID);
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Semi-joins_and_Anti-joins">Semi-joins and Anti-joins</h2> 
 <p>Queries with IN/NOT IN or EXISTS/NOT EXISTS are implemented with semi-joins and anti-joins wherever possible. A semi-join is different from a conventional join in that rows in the first table will be returned at most once, regardless of how many matches the second table contains for a certain row in the first table. A semi-join returns all those rows from the first table which can find at least one match in the second table. An IN or EXISTS construct is often translated into semi-joins.</p> 
 <p>An anti-join is the opposite of a semi-join. The results of an anti-join are all those rows from the first table that can find no match in the second table. A NOT IN or NOT EXISTS construct is often translated into anti-joins.</p> 
 <div class="section"> 
  <h3 id="Semi-join_Optimization">Semi-join Optimization</h3> 
  <p>The “<a href="joins.html#foreign-key-to-primary-key-join-optimization">Foreign Key to Primary Key Join Optimization</a>” mentioned in Phoenix <a href="joins.html">Joins</a> is equally applied to semi-joins. So if a skip-scan is driven for a semi-join qualified for this optimization and the IN or EXISTS semantics can be fully substituted by the skip-scan alone, the server-side join operation will not happen at all.</p> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Subqueries_with_Comparison_Operators">Subqueries with Comparison Operators</h2> 
 <p>Subqueries can be specified as the right-hand-side operand of the comparison operators (=, &lt; &gt;, &gt;, &gt; =, &lt;, ! &gt;, ! &lt;, or &lt; =).</p> 
 <p>The below example is to find the participants whose contest scores are greater than the overall average score.</p> 
 <div class="source"> 
  <pre>SELECT ID, Name
FROM Contest
WHERE Score &gt;
    (SELECT avg(Score)
     FROM Contest)
ORDER BY Score DESC;
</pre> 
 </div> 
 <p>A subquery introduced with an unmodified comparison operator (a comparison operator not followed by ANY or ALL) must only return a single row; otherwise it would result in getting a SQL error message.</p> 
</div> 
<div class="section"> 
 <h2 id="Subqueries_with_ANYSOMEALL_Comparison_Operators">Subqueries with ANY/SOME/ALL Comparison Operators</h2> 
 <p>Subqueries can be introduced with a comparison operator modified by the keywords ANY, SOME or ALL, which has exactly the same semantics with static arrays, only that the array elements have to be dynamically computed through the execution of the inner query.</p> 
 <p>The following query provides an example which lists the orders with a quantity greater than or equal to the maximum order quantity of any item.</p> 
 <div class="source"> 
  <pre>SELECT OrderID
FROM Orders
WHERE quantity &gt;= ANY
    (SELECT max(quantity)
     FROM Orders
     GROUP BY ItemID);
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Correlated_Subqueries">Correlated Subqueries</h2> 
 <p>Correlated subqueries (also known as synchronized subqueries) are subqueries that contain references to the outer queries. Unlike independent subqueries, which only need to be evaluated once, the correlated inner query result depends on the outer query values and may differ from row to row.</p> 
 <p>The following example finds the patents filed earlier than or equal to all patents filed within the same region:</p> 
 <div class="source"> 
  <pre>SELECT PatentID, Title
FROM Patents p
WHERE FileDate &lt;= ALL
    (SELECT FileDate
     FROM Patents
     WHERE Region = p.Region);
</pre> 
 </div> 
 <p>Phoenix optimizes such queries by rewriting them into equivalent join queries so that the inner query only has be to executed once instead of for each row in the outer query. The above correlated subquery will be rewritten in Phoenix as:</p> 
 <div class="source"> 
  <pre>SELECT PatentID, Title
FROM Patents p
JOIN
    (SELECT Region col1, collect_distinct(FileDate) col2
     FROM Patent
     GROUP BY Region) t1
ON Region = t1.col1
WHERE FileDate &lt;= ALL(t1.col2);
</pre> 
 </div> 
 <p>Here, <i>collect_distinct()</i> is a reserved internal funtion in Phoenix, which essentially collects all different values of a certain column or expression into a Phoenix Array.</p> 
</div> 
<div class="section"> 
 <h2 id="ANDOR_Branches_and_Multiple_levels_of_Nesting">AND/OR Branches and Multiple levels of Nesting</h2> 
 <p>Correlated subqueries or independent subqueries can be specified anywhere in the WHERE clause, whether in AND branches or in OR branches. And a query can have more than one level of subquery nesting, which means a subquery can include yet another (or more) subquery in itself.</p> 
 <p>Below is an example of a complicated query that has multiple levels of subqueries connected with AND and OR branches, which is to find the items not involved in the orders sold to customers in Belgium with a quantity lower than 1000 or to customers in Germany with a quantity lower than 2000:</p> 
 <div class="source"> 
  <pre>SELECT ItemID, ItemName
FROM Items i
WHERE NOT EXISTS
    (SELECT *
     FROM Orders
     WHERE CustomerID IN
         (SELECT CustomerID
          FROM Customers
          WHERE Country = ‘Belgium’)
     AND Quantity &lt; 1000
     AND ItemID = i.ItemID)
OR ItemID != ALL
    (SELECT ItemID
     FROM Orders
     WHERE CustomerID IN
         (SELECT CustomerID
          FROM Customers
          WHERE Country = ‘Germany’)
     AND Quantity &lt; 2000);
</pre> 
 </div> 
</div> 
<div class="section"> 
 <h2 id="Row_subqueries">Row subqueries</h2> 
 <p>A subquery can return multiple fields in one row, which is considered returning a row constructor. The row constructor on both sides of the operator (IN/NOT IN, EXISTS/NOT EXISTS or comparison operator) must contain the same number of values, like in the below example:</p> 
 <div class="source"> 
  <pre>SELECT column1, column2
FROM t1
WHERE (column1, column2) IN
    (SELECT column3, column4
     FROM t2
     WHERE column5 = ‘nowhere’);
</pre> 
 </div> 
 <p>This query returns all pairs of (column1, column2) that can match any pair of (column3, column4) in the second table after being filtered by condition: column5 = ‘nowhere’.</p> 
</div> 
<div class="section"> 
 <h2 id="Derived_Tables">Derived Tables</h2> 
 <p>Subqueries specified in the FROM clause are also called derived tables. For example, suppose you want to list a set of maximum values of a grouped table by their frequency of occurrence, and the below query will return the desired result:</p> 
 <div class="source"> 
  <pre>SELECT m, count(*) 
FROM 
    (SELECT max(x) m 
     FROM a1 
     GROUP BY name) AS t 
GROUP BY m
ORDER BY count(*) DESC;
</pre> 
 </div> 
 <p>Derived tables can also be specified anywhere in a join query as join-tables. Please refer to the “<a href="joins.html#grouped-joins-and-derived-tables">Grouped Joins and Derived Tables</a>” section of Phoenix <a href="joins.html">Joins</a> for more information and examples.</p> 
</div> 
<div class="section"> 
 <h2 id="Limitations">Limitations</h2> 
 <p>In our Phoenix 3.2 and 4.2 releases, the subquery support has the following restrictions:</p> 
 <ol style="list-style-type: decimal"> 
  <li><a class="externalLink" href="https://issues.apache.org/jira/browse/PHOENIX-1388">PHOENIX-1388</a> Support correlated subqueries in the HAVING clause.</li> 
  <li><a class="externalLink" href="https://issues.apache.org/jira/browse/PHOENIX-1392">PHOENIX-1392</a> Using subqueries as expressions.</li> 
 </ol> 
</div>
			</div>
		</div>
	</div>
	</div>

	</div><!-- /container -->
	
	<!-- Footer
	================================================== -->
	<footer class="well">
		<div class="container">
			<div class="row">
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">About</li>
						<li >
							<a href="index.html" title="Overview">Overview</a>
						</li>
						<li >
							<a href="recent.html" title="New Features">New Features</a>
						</li>
						<li >
							<a href="roadmap.html" title="Roadmap">Roadmap</a>
						</li>
						<li >
							<a href="performance.html" title="Performance">Performance</a>
						</li>
						<li >
							<a href="team.html" title="Team">Team</a>
						</li>
						<li >
							<a href="contributing.html" title="Contributing">Contributing</a>
						</li>
						<li >
							<a href="resources.html" title="Resources">Resources</a>
						</li>
						<li >
							<a href="mailing_list.html" title="Mailing Lists">Mailing Lists</a>
						</li>
						<li >
							<a href="source.html" title="Source Repository">Source Repository</a>
						</li>
						<li >
							<a href="issues.html" title="Issue Tracking">Issue Tracking</a>
						</li>
						<li >
							<a href="download.html" title="Download">Download</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="release.html" title="How to release">How to release</a>
						</li>
						<li >
							<a href="building_website.html" title="How to update website">How to update website</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="http://www.apache.org/licenses/" title="License" class="externalLink">License</a>
						</li>
						<li >
							<a href="http://www.apache.org/foundation/sponsorship.html" title="Sponsorship" class="externalLink">Sponsorship</a>
						</li>
						<li >
							<a href="http://www.apache.org/foundation/thanks.html" title="Thanks" class="externalLink">Thanks</a>
						</li>
						<li >
							<a href="http://www.apache.org/security/" title="Security" class="externalLink">Security</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Using</li>
						<li >
							<a href="faq.html" title="F.A.Q.">F.A.Q.</a>
						</li>
						<li >
							<a href="Phoenix-in-15-minutes-or-less.html" title="Quick Start">Quick Start</a>
						</li>
						<li >
							<a href="building.html" title="Building">Building</a>
						</li>
						<li >
							<a href="tuning.html" title="Tuning">Tuning</a>
						</li>
						<li >
							<a href="upgrading.html" title="Upgrading">Upgrading</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="secondary_indexing.html" title="Secondary Indexes">Secondary Indexes</a>
						</li>
						<li >
							<a href="joins.html" title="Joins">Joins</a>
						</li>
						<li class="active">
							<a href="#" title="Subqueries">Subqueries</a>
						</li>
						<li >
							<a href="views.html" title="Views">Views</a>
						</li>
						<li >
							<a href="multi-tenancy.html" title="Multi tenancy">Multi tenancy</a>
						</li>
						<li >
							<a href="sequences.html" title="Sequences">Sequences</a>
						</li>
						<li >
							<a href="array_type.html" title="ARRAY type">ARRAY type</a>
						</li>
						<li >
							<a href="salted.html" title="Salted Tables">Salted Tables</a>
						</li>
						<li >
							<a href="paged.html" title="Paged Queries">Paged Queries</a>
						</li>
						<li >
							<a href="dynamic_columns.html" title="Dynamic Columns">Dynamic Columns</a>
						</li>
						<li >
							<a href="skip_scan.html" title="Skip Scan">Skip Scan</a>
						</li>
						<li >
							<a href="bulk_dataload.html" title="Bulk Loading">Bulk Loading</a>
						</li>
						<li >
							<a href="tracing.html" title="Tracing">Tracing</a>
						</li>
						<li >
							<a href="update_statistics.html" title="Statistics Collection">Statistics Collection</a>
						</li>
						<li >
							<a href="http:divider" title=""></a>
						</li>
						<li >
							<a href="phoenix_on_emr.html" title="Amazon EMR Support">Amazon EMR Support</a>
						</li>
						<li >
							<a href="flume.html" title="Apache Flume Plugin">Apache Flume Plugin</a>
						</li>
						<li >
							<a href="pig_integration.html" title="Apache Pig Integration">Apache Pig Integration</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-nav">
					<ul class="nav nav-list">
						<li class="nav-header">Reference</li>
						<li >
							<a href="language/index.html" title="Grammar">Grammar</a>
						</li>
						<li >
							<a href="language/functions.html" title="Functions">Functions</a>
						</li>
						<li >
							<a href="language/datatypes.html" title="Datatypes">Datatypes</a>
						</li>
					</ul>
				</div>
				<div class="span3 bottom-description">
					<form action="http://search-hadoop.com/?" method="get"><input value="Phoenix" name="fc_project" type="hidden"><input placeholder="Search Phoenix&hellip;" required="required" style="width:170px;" size="18" name="q" id="query" type="search"></form>
				</div>
			</div>
		</div>
	</footer>
		
	<div class="container subfooter">
		<div class="row">
			<div class="span12">
				<p class="pull-right"><a href="#">Back to top</a></p>
				<p class="copyright">Copyright &copy;2014 <a href="http://www.apache.org">Apache Software Foundation</a>. All Rights Reserved.</p>
			</div>
		</div>
	</div>

	<!-- Le javascript
	================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
	<script src="./js/lightbox.js"></script>
	<script src="./js/jquery.smooth-scroll.min.js"></script>
	<!-- back button support for smooth scroll -->
	<script src="./js/jquery.ba-bbq.min.js"></script>
	<script src="http://yandex.st/highlightjs/7.5/highlight.min.js"></script>

	<script src="./js/reflow-skin.js"></script>
	
	</body>
</html>
